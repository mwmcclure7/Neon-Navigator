<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Navigator</title>
    <style>
        body {
            background-color: black;
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
        }
        #gameCanvas {
            display: none;
            margin: 0 auto;
        }
        #menu, #roundEnd, #settingsMenu {
            margin: 20px auto;
            width: 400px;
        }
        button {
            margin: 5px;
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        button:hover {
            background-color: #ddd;
        }
        input[type="number"], input[type="color"] {
            padding: 5px;
            font-size: 16px;
        }
        #highScore {
            font-size: 24px;
            font-weight: bold;
        }
        #difficultyOptions {
            display: none;
        }
    </style>
</head>
<body>
    <div id="menu">
        <h1>Neon Navigator</h1>
        <p>High Score: <span id="highScore">0</span></p>
        <p>Game Type:
            <button id="pvpMode">PvP</button>
            <button id="survivalMode">Survival</button>
        </p>
        <p>Players:
            <button id="singlePlayer">Single Player</button>
            <button id="twoPlayer">Two Player</button>
            <button id="threePlayer">Three Player</button>
        </p>
        <p id="difficultyOptions">Difficulty (Survival Mode):
            <button id="easy">Easy</button>
            <button id="medium">Medium</button>
            <button id="hard">Hard</button>
        </p>
        <button id="start">Start Round</button>
        <button id="settings">Settings</button>
    </div>
    <div id="settingsMenu" style="display: none;">
        <h2>Settings</h2>
        <label for="rotationSpeed">Rotation Speed (rad/s): </label>
        <input type="number" id="rotationSpeed" step="0.1" min="0.1" value="6.28"><br>
        <label for="acceleration">Acceleration (px/sÂ²): </label>
        <input type="number" id="acceleration" step="10" min="10" value="1000"><br>
        <label for="size">Player Size: </label>
        <input type="number" id="size" step="1" min="10" value="20"><br>
        <label for="colorPlayer1">Player 1 Color: </label>
        <input type="color" id="colorPlayer1" value="#ffffff"><br>
        <label for="colorPlayer2">Player 2 Color: </label>
        <input type="color" id="colorPlayer2" value="#ffff00"><br>
        <label for="colorPlayer3">Player 3 Color: </label>
        <input type="color" id="colorPlayer3" value="#00ff00"><br>
        <label for="shootCooldown">Shoot Cooldown (s): </label>
        <input type="number" id="shootCooldown" step="0.1" min="0.1" value="0.5"><br>
        <label for="numBullets">Number of Bullets: </label>
        <input type="number" id="numBullets" min="1" max="10" step="1" value="1"><br>
        <label for="bulletSpeed">Bullet Speed (px/s): </label>
        <input type="number" id="bulletSpeed" step="10" min="50" value="200"><br>
        <button id="saveSettings">Save Settings</button>
        <button id="backFromSettings">Back</button>
    </div>
    <div id="roundEnd" style="display: none;">
        <h2>Round Over</h2>
        <p id="result"></p>
        <button id="backToMenu">Back to Menu</button>
        <button id="playAgain">Play Again</button>
    </div>
    <canvas id="gameCanvas"></canvas>
    <audio id="backgroundMusic" loop>
        <source src="background.mp3" type="audio/mpeg">
    </audio>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        // UI elements
        const menuDiv = document.getElementById('menu');
        const settingsMenuDiv = document.getElementById('settingsMenu');
        const roundEndDiv = document.getElementById('roundEnd');
        const highScoreSpan = document.getElementById('highScore');
        const startButton = document.getElementById('start');
        const settingsButton = document.getElementById('settings');
        const saveSettingsButton = document.getElementById('saveSettings');
        const backFromSettingsButton = document.getElementById('backFromSettings');
        const resultP = document.getElementById('result');
        const backToMenuButton = document.getElementById('backToMenu');
        const playAgainButton = document.getElementById('playAgain');
        const singlePlayerButton = document.getElementById('singlePlayer');
        const twoPlayerButton = document.getElementById('twoPlayer');
        const threePlayerButton = document.getElementById('threePlayer');
        const pvpModeButton = document.getElementById('pvpMode');
        const survivalModeButton = document.getElementById('survivalMode');
        const easyButton = document.getElementById('easy');
        const mediumButton = document.getElementById('medium');
        const hardButton = document.getElementById('hard');
        const difficultyOptions = document.getElementById('difficultyOptions');

        // Settings inputs
        const rotationSpeedInput = document.getElementById('rotationSpeed');
        const accelerationInput = document.getElementById('acceleration');
        const sizeInput = document.getElementById('size');
        const colorPlayer1Input = document.getElementById('colorPlayer1');
        const colorPlayer2Input = document.getElementById('colorPlayer2');
        const colorPlayer3Input = document.getElementById('colorPlayer3');
        const shootCooldownInput = document.getElementById('shootCooldown');
        const numBulletsInput = document.getElementById('numBullets');
        const bulletSpeedInput = document.getElementById('bulletSpeed');

        // Audio elements
        const backgroundMusic = document.getElementById('backgroundMusic');
        const laserSound = new Audio('laser.mp3');
        const explosionSound = new Audio('explosion.mp3');
        const clickSound = new Audio('click.mp3');

        // Game state variables
        let gameState = 'menu';
        let gameMode = 'single';
        let gameType = 'pvp';
        let difficulty = 'easy';
        let highScores = {
            survival: {
                single: { easy: 0, medium: 0, hard: 0 },
                twoPlayer: { easy: 0, medium: 0, hard: 0 },
                threePlayer: { easy: 0, medium: 0, hard: 0 }
            },
            pvp: { single: 0, twoPlayer: 0, threePlayer: 0 }
        };
        let players = [];
        let hazards = [];
        let explosions = [];
        let shotCount = 0;
        let survivalTime = 0;
        let lastBulletSpawn = 0;
        let gameOver = false;
        let gameOverTimer = 0;
        let hitPlayerIndex = -1;
        const animationDuration = 1;

        // Load high scores
        if (localStorage.getItem('highScores')) {
            highScores = JSON.parse(localStorage.getItem('highScores'));
        }
        highScoreSpan.textContent = highScores.pvp.single;

        // Default settings
        const defaultSettings = {
            rotationSpeed: 6.28,
            acceleration: 1000,
            size: 20,
            colorPlayer1: '#ffffff',
            colorPlayer2: '#ffff00',
            colorPlayer3: '#00ff00',
            shootCooldown: 0.5,
            numBullets: 1,
            bulletSpeed: 200
        };
        let storedSettings = localStorage.getItem('settings') ? JSON.parse(localStorage.getItem('settings')) : {};
        let settings = { ...defaultSettings, ...storedSettings };

        // Initialize settings inputs
        rotationSpeedInput.value = settings.rotationSpeed;
        accelerationInput.value = settings.acceleration;
        sizeInput.value = settings.size;
        colorPlayer1Input.value = settings.colorPlayer1;
        colorPlayer2Input.value = settings.colorPlayer2;
        colorPlayer3Input.value = settings.colorPlayer3;
        shootCooldownInput.value = settings.shootCooldown;
        numBulletsInput.value = settings.numBullets;
        bulletSpeedInput.value = settings.bulletSpeed;

        // Key mappings
        const keysPlayer1 = { up: false, left: false, right: false, shoot: false };
        const keysPlayer2 = { up: false, left: false, right: false, shoot: false };
        const keysPlayer3 = { up: false, left: false, right: false, shoot: false };

        // Stop all audio
        function stopAllAudio() {
            backgroundMusic.pause();
            backgroundMusic.currentTime = 0;
            laserSound.pause();
            laserSound.currentTime = 0;
            explosionSound.pause();
            explosionSound.currentTime = 0;
            clickSound.pause();
            clickSound.currentTime = 0;
            players.forEach(player => {
                if (player.engineSound) {
                    player.engineSound.pause();
                    player.engineSound.currentTime = 0;
                }
            });
        }

        // Game type selection
        pvpModeButton.addEventListener('click', () => {
            gameType = 'pvp';
            pvpModeButton.style.backgroundColor = 'yellow';
            survivalModeButton.style.backgroundColor = '';
            difficultyOptions.style.display = 'none';
            updateHighScoreDisplay();
            clickSound.play();
        });
        survivalModeButton.addEventListener('click', () => {
            gameType = 'survival';
            survivalModeButton.style.backgroundColor = 'yellow';
            pvpModeButton.style.backgroundColor = '';
            difficultyOptions.style.display = 'block';
            updateHighScoreDisplay();
            clickSound.play();
        });
        pvpModeButton.style.backgroundColor = 'yellow';

        // Player selection
        singlePlayerButton.addEventListener('click', () => {
            gameMode = 'single';
            singlePlayerButton.style.backgroundColor = 'yellow';
            twoPlayerButton.style.backgroundColor = '';
            threePlayerButton.style.backgroundColor = '';
            updateHighScoreDisplay();
            clickSound.play();
        });
        twoPlayerButton.addEventListener('click', () => {
            gameMode = 'twoPlayer';
            twoPlayerButton.style.backgroundColor = 'yellow';
            singlePlayerButton.style.backgroundColor = '';
            threePlayerButton.style.backgroundColor = '';
            updateHighScoreDisplay();
            clickSound.play();
        });
        threePlayerButton.addEventListener('click', () => {
            gameMode = 'threePlayer';
            threePlayerButton.style.backgroundColor = 'yellow';
            singlePlayerButton.style.backgroundColor = '';
            twoPlayerButton.style.backgroundColor = '';
            updateHighScoreDisplay();
            clickSound.play();
        });
        singlePlayerButton.style.backgroundColor = 'yellow';

        // Difficulty selection
        easyButton.addEventListener('click', () => {
            difficulty = 'easy';
            easyButton.style.backgroundColor = 'yellow';
            mediumButton.style.backgroundColor = '';
            hardButton.style.backgroundColor = '';
            updateHighScoreDisplay();
            clickSound.play();
        });
        mediumButton.addEventListener('click', () => {
            difficulty = 'medium';
            mediumButton.style.backgroundColor = 'yellow';
            easyButton.style.backgroundColor = '';
            hardButton.style.backgroundColor = '';
            updateHighScoreDisplay();
            clickSound.play();
        });
        hardButton.addEventListener('click', () => {
            difficulty = 'hard';
            hardButton.style.backgroundColor = 'yellow';
            easyButton.style.backgroundColor = '';
            mediumButton.style.backgroundColor = '';
            updateHighScoreDisplay();
            clickSound.play();
        });
        easyButton.style.backgroundColor = 'yellow';

        // Settings button
        settingsButton.addEventListener('click', () => {
            menuDiv.style.display = 'none';
            settingsMenuDiv.style.display = 'block';
            clickSound.play();
        });

        // Save settings
        saveSettingsButton.addEventListener('click', () => {
            settings.rotationSpeed = parseFloat(rotationSpeedInput.value);
            settings.acceleration = parseFloat(accelerationInput.value);
            settings.size = parseInt(sizeInput.value);
            settings.colorPlayer1 = colorPlayer1Input.value;
            settings.colorPlayer2 = colorPlayer2Input.value;
            settings.colorPlayer3 = colorPlayer3Input.value;
            settings.shootCooldown = parseFloat(shootCooldownInput.value);
            settings.numBullets = Math.min(10, Math.max(1, parseInt(numBulletsInput.value || 1)));
            settings.bulletSpeed = parseFloat(bulletSpeedInput.value);
            localStorage.setItem('settings', JSON.stringify(settings));
            clickSound.play();
        });

        // Back from settings
        backFromSettingsButton.addEventListener('click', () => {
            settingsMenuDiv.style.display = 'none';
            menuDiv.style.display = 'block';
            clickSound.play();
        });

        // Start round
        startButton.addEventListener('click', () => {
            initializeRound();
            gameState = 'playing';
            menuDiv.style.display = 'none';
            roundEndDiv.style.display = 'none';
            settingsMenuDiv.style.display = 'none';
            canvas.style.display = 'block';
            backgroundMusic.play();
            clickSound.play();
        });

        // Back to menu
        backToMenuButton.addEventListener('click', () => {
            stopAllAudio();
            location.reload();
            clickSound.play();
        });

        // Play again
        playAgainButton.addEventListener('click', () => {
            initializeRound();
            gameState = 'playing';
            roundEndDiv.style.display = 'none';
            canvas.style.display = 'block';
            backgroundMusic.play();
            clickSound.play();
        });

        // Keyboard input
        window.addEventListener('keydown', (e) => {
            if (e.key === 'w') keysPlayer1.up = true;
            if (e.key === 'a') keysPlayer1.left = true;
            if (e.key === 'd') keysPlayer1.right = true;
            if (e.key === 's' && gameType === 'pvp') keysPlayer1.shoot = true;
            if (e.key === 'ArrowUp') keysPlayer2.up = true;
            if (e.key === 'ArrowLeft') keysPlayer2.left = true;
            if (e.key === 'ArrowRight') keysPlayer2.right = true;
            if (e.key === 'ArrowDown' && gameType === 'pvp') keysPlayer2.shoot = true;
            if (e.key === 'y') keysPlayer3.up = true;
            if (e.key === 'g') keysPlayer3.left = true;
            if (e.key === 'j') keysPlayer3.right = true;
            if (e.key === 'h' && gameType === 'pvp') keysPlayer3.shoot = true;
            if (e.key === 'r' && gameState === 'roundEnd') {
                initializeRound();
                gameState = 'playing';
                roundEndDiv.style.display = 'none';
                canvas.style.display = 'block';
                backgroundMusic.play();
                clickSound.play();
            }
        });
        window.addEventListener('keyup', (e) => {
            if (e.key === 'w') keysPlayer1.up = false;
            if (e.key === 'a') keysPlayer1.left = false;
            if (e.key === 'd') keysPlayer1.right = false;
            if (e.key === 's') keysPlayer1.shoot = false;
            if (e.key === 'ArrowUp') keysPlayer2.up = false;
            if (e.key === 'ArrowLeft') keysPlayer2.left = false;
            if (e.key === 'ArrowRight') keysPlayer2.right = false;
            if (e.key === 'ArrowDown') keysPlayer2.shoot = false;
            if (e.key === 'y') keysPlayer3.up = false;
            if (e.key === 'g') keysPlayer3.left = false;
            if (e.key === 'j') keysPlayer3.right = false;
            if (e.key === 'h') keysPlayer3.shoot = false;
        });

        // Player class
        class Player {
            constructor(x, y, keys, color) {
                this.position = { x, y };
                this.velocity = { x: 0, y: 0 };
                this.angle = 0;
                this.rotationSpeed = settings.rotationSpeed;
                this.acceleration = settings.acceleration;
                this.size = settings.size;
                this.collisionRadius = settings.size / 2;
                this.keys = keys;
                this.color = color;
                this.shootCooldown = 0;
                this.shootCooldownTime = settings.shootCooldown;
                this.engineSound = new Audio('engine.mp3');
                this.engineSound.loop = true;
                this.alive = true;
            }
            update(delta) {
                if (!this.alive) return;
                if (this.keys.left) this.angle -= this.rotationSpeed * delta;
                if (this.keys.right) this.angle += this.rotationSpeed * delta;
                if (this.keys.up) {
                    this.velocity.x += Math.sin(this.angle) * this.acceleration * delta;
                    this.velocity.y -= Math.cos(this.angle) * this.acceleration * delta;
                    if (this.engineSound.paused) this.engineSound.play();
                } else {
                    this.engineSound.pause();
                    this.engineSound.currentTime = 0;
                }
                this.position.x += this.velocity.x * delta;
                this.position.y += this.velocity.y * delta;
                if (this.position.x < 0) this.position.x += canvas.width;
                if (this.position.x > canvas.width) this.position.x -= canvas.width;
                if (this.position.y < 0) this.position.y += canvas.height;
                if (this.position.y > canvas.height) this.position.y -= canvas.height;

                if (gameType === 'pvp' && this.keys.shoot && this.shootCooldown <= 0) {
                    const numBullets = settings.numBullets;
                    const offset = this.size + 5;
                    const shootSpeed = settings.bulletSpeed;

                    if (numBullets === 1) {
                        const spawnX = this.position.x + Math.sin(this.angle) * offset;
                        const spawnY = this.position.y - Math.cos(this.angle) * offset;
                        const shootVx = Math.sin(this.angle) * shootSpeed;
                        const shootVy = -Math.cos(this.angle) * shootSpeed;
                        const hazardVx = this.velocity.x + shootVx;
                        const hazardVy = this.velocity.y + shootVy;
                        const speed = Math.sqrt(hazardVx ** 2 + hazardVy ** 2);
                        hazards.push(new Hazard(spawnX, spawnY, speed, { x: hazardVx / speed, y: hazardVy / speed }));
                    } else {
                        const spreadDegrees = numBullets === 10 ? 360 : 40 * (numBullets - 1);
                        const spreadRadians = spreadDegrees * Math.PI / 180;
                        const angleStep = spreadRadians / (numBullets - 1 || 1);
                        const startAngle = this.angle - (spreadRadians / 2);

                        for (let i = 0; i < numBullets; i++) {
                            const bulletAngle = numBullets === 10 ? this.angle + (i * 2 * Math.PI / numBullets) : startAngle + (i * angleStep);
                            const spawnX = this.position.x + Math.sin(bulletAngle) * offset;
                            const spawnY = this.position.y - Math.cos(bulletAngle) * offset;
                            const shootVx = Math.sin(bulletAngle) * shootSpeed;
                            const shootVy = -Math.cos(bulletAngle) * shootSpeed;
                            const hazardVx = this.velocity.x + shootVx;
                            const hazardVy = this.velocity.y + shootVy;
                            const speed = Math.sqrt(hazardVx ** 2 + hazardVy ** 2);
                            hazards.push(new Hazard(spawnX, spawnY, speed, { x: hazardVx / speed, y: hazardVy / speed }));
                        }
                    }

                    this.shootCooldown = this.shootCooldownTime;
                    laserSound.play();
                    if (gameMode === 'single') shotCount++;
                }
                if (this.shootCooldown > 0) this.shootCooldown -= delta;
            }
            draw(ctx) {
                if (!this.alive) return;
                ctx.save();
                ctx.translate(this.position.x, this.position.y);
                ctx.rotate(this.angle);
                ctx.beginPath();
                ctx.moveTo(0, -this.size);
                ctx.lineTo(-this.size, this.size);
                ctx.lineTo(this.size, this.size);
                ctx.closePath();
                ctx.fillStyle = this.color;
                ctx.fill();
                if (this.keys.up) {
                    ctx.beginPath();
                    ctx.moveTo(-this.size / 2, this.size);
                    ctx.lineTo(0, this.size * 1.5);
                    ctx.lineTo(this.size / 2, this.size);
                    ctx.closePath();
                    ctx.fillStyle = 'orange';
                    ctx.fill();
                }
                ctx.restore();
            }
        }

        // Hazard class
        class Hazard {
            constructor(x, y, speed, direction) {
                this.position = { x, y };
                this.speed = speed;
                this.direction = direction;
                this.size = 10;
            }
            update(delta) {
                this.position.x += this.direction.x * this.speed * delta;
                this.position.y += this.direction.y * this.speed * delta;
                if (this.position.x < 0 || this.position.x > canvas.width) this.direction.x *= -1;
                if (this.position.y < 0 || this.position.y > canvas.height) this.direction.y *= -1;
            }
            draw(ctx) {
                ctx.beginPath();
                ctx.arc(this.position.x, this.position.y, this.size / 2, 0, Math.PI * 2);
                ctx.fillStyle = 'red';
                ctx.fill();
            }
        }

        // Explosion class
        class Explosion {
            constructor(x, y) {
                this.position = { x, y };
                this.radius = 0;
                this.maxRadius = 50;
                this.duration = 1;
                this.timer = 0;
            }
            update(delta) {
                this.timer += delta;
                if (this.timer < this.duration) {
                    this.radius = (this.timer / this.duration) * this.maxRadius;
                }
            }
            draw(ctx) {
                if (this.timer < this.duration) {
                    ctx.beginPath();
                    ctx.arc(this.position.x, this.position.y, this.radius, 0, Math.PI * 2);
                    ctx.strokeStyle = 'rgba(255, 0, 0, ' + (1 - this.timer / this.duration) + ')';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            }
        }

        // Utility functions
        function distance(p1, p2) {
            return Math.sqrt((p1.x - p2.x) ** 2 + (p1.y - p2.y) ** 2);
        }

        function updateHighScoreDisplay() {
            if (gameType === 'pvp') {
                highScoreSpan.textContent = highScores.pvp[gameMode];
            } else {
                highScoreSpan.textContent = highScores.survival[gameMode][difficulty];
            }
        }

        function spawnSurvivalHazard() {
            const edge = Math.floor(Math.random() * 4);
            let x, y, direction;
            const speed = Math.random() * (settings.bulletSpeed * 1.5 - settings.bulletSpeed * 0.5) + settings.bulletSpeed * 0.5;

            switch (edge) {
                case 0: // Top
                    x = Math.random() * canvas.width;
                    y = 0;
                    direction = { x: Math.random() * 2 - 1, y: 1 };
                    break;
                case 1: // Right
                    x = canvas.width;
                    y = Math.random() * canvas.height;
                    direction = { x: -1, y: Math.random() * 2 - 1 };
                    break;
                case 2: // Bottom
                    x = Math.random() * canvas.width;
                    y = canvas.height;
                    direction = { x: Math.random() * 2 - 1, y: -1 };
                    break;
                case 3: // Left
                    x = 0;
                    y = Math.random() * canvas.height;
                    direction = { x: 1, y: Math.random() * 2 - 1 };
                    break;
            }
            const mag = Math.sqrt(direction.x ** 2 + direction.y ** 2);
            direction.x /= mag;
            direction.y /= mag;
            hazards.push(new Hazard(x, y, speed, direction));
        }

        // Initialize round
        function initializeRound() {
            players = [];
            hazards = [];
            explosions = [];
            shotCount = 0;
            survivalTime = 0;
            lastBulletSpawn = 0;
            gameOver = false;
            gameOverTimer = 0;
            hitPlayerIndex = -1;

            if (gameMode === 'single') {
                players.push(new Player(canvas.width / 2, canvas.height / 2, keysPlayer1, settings.colorPlayer1));
            } else if (gameMode === 'twoPlayer') {
                players.push(new Player(canvas.width / 4, canvas.height / 2, keysPlayer1, settings.colorPlayer1));
                players.push(new Player(3 * canvas.width / 4, canvas.height / 2, keysPlayer2, settings.colorPlayer2));
            } else if (gameMode === 'threePlayer') {
                players.push(new Player(canvas.width / 4, canvas.height / 2, keysPlayer1, settings.colorPlayer1));
                players.push(new Player(canvas.width / 2, canvas.height / 2, keysPlayer2, settings.colorPlayer2));
                players.push(new Player(3 * canvas.width / 4, canvas.height / 2, keysPlayer3, settings.colorPlayer3));
            }
        }

        // Draw grid background
        function drawGrid() {
            ctx.strokeStyle = 'rgba(0, 255, 255, 0.2)';
            for (let x = 0; x <= canvas.width; x += 50) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            for (let y = 0; y <= canvas.height; y += 50) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }

        // Game loop
        let lastTime = 0;
        function gameLoop(currentTime) {
            const delta = Math.min((currentTime - lastTime) / 1000, 0.1);
            lastTime = currentTime;

            if (gameState === 'playing') {
                if (!gameOver) {
                    players.forEach(player => player.update(delta));
                    hazards.forEach(hazard => hazard.update(delta));

                    // Survival mode bullet spawning
                    if (gameType === 'survival') {
                        survivalTime += delta;
                        const spawnInterval = difficulty === 'easy' ? 2 : difficulty === 'medium' ? 1 : 0.5;
                        if (survivalTime - lastBulletSpawn >= spawnInterval) {
                            spawnSurvivalHazard();
                            lastBulletSpawn = survivalTime;
                        }
                    }

                    // Collision detection
                    players.forEach((player, index) => {
                        if (!player.alive) return;
                        hazards.forEach(hazard => {
                            if (distance(player.position, hazard.position) < player.collisionRadius + hazard.size / 2) {
                                player.alive = false;
                                explosions.push(new Explosion(player.position.x, player.position.y));
                                explosionSound.play();
                                hitPlayerIndex = index;
                            }
                        });
                    });

                    const alivePlayers = players.filter(p => p.alive);
                    if (gameMode === 'single' && alivePlayers.length === 0) {
                        gameOver = true;
                    } else if (gameMode === 'twoPlayer' && alivePlayers.length <= 1) {
                        gameOver = true;
                    } else if (gameMode === 'threePlayer' && alivePlayers.length <= 1) {
                        gameOver = true;
                    }
                } else {
                    gameOverTimer += delta;
                    if (gameOverTimer >= animationDuration) {
                        const alivePlayers = players.filter(p => p.alive);
                        let message = '';
                        if (gameType === 'pvp') {
                            if (gameMode === 'single') {
                                message = `You Lose! Shots fired: ${shotCount}`;
                            } else if (alivePlayers.length === 1) {
                                const winnerIndex = players.indexOf(alivePlayers[0]) + 1;
                                message = `Player ${winnerIndex} Wins!`;
                            } else {
                                message = 'No Winner!';
                            }
                        } else {
                            if (gameMode === 'single') {
                                message = `Survived: ${survivalTime.toFixed(1)}s`;
                            } else if (alivePlayers.length === 1) {
                                const winnerIndex = players.indexOf(alivePlayers[0]) + 1;
                                message = `Player ${winnerIndex} Wins!`;
                            } else {
                                message = 'No Winner!';
                            }
                        }
                        endRound(alivePlayers.length > 0, message);
                    }
                }

                explosions.forEach(explosion => explosion.update(delta));
                explosions = explosions.filter(explosion => explosion.timer < explosion.duration);

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawGrid();
                players.forEach(player => player.draw(ctx));
                hazards.forEach(hazard => hazard.draw(ctx));
                explosions.forEach(explosion => explosion.draw(ctx));

                ctx.fillStyle = 'white';
                ctx.font = '20px Arial';
                if (gameType === 'pvp' && gameMode === 'single') {
                    ctx.fillText(`Shots: ${shotCount}`, 10, 30);
                } else if (gameType === 'survival') {
                    ctx.fillText(`Time: ${survivalTime.toFixed(1)}s`, 10, 30);
                } else {
                    ctx.fillText(`Player 1`, 10, 30);
                    ctx.fillText(`Player 2`, canvas.width - 100, 30);
                    if (gameMode === 'threePlayer') {
                        ctx.fillText(`Player 3`, canvas.width / 2 - 50, 30);
                    }
                }
            }

            requestAnimationFrame(gameLoop);
        }

        // End round
        function endRound(win, message = '') {
            gameState = 'roundEnd';
            resultP.textContent = message;
            if (gameType === 'pvp' && gameMode === 'single' && shotCount > highScores.pvp.single) {
                highScores.pvp.single = shotCount;
                localStorage.setItem('highScores', JSON.stringify(highScores));
                updateHighScoreDisplay();
            } else if (gameType === 'survival' && gameMode === 'single' && survivalTime > highScores.survival.single[difficulty]) {
                highScores.survival.single[difficulty] = Math.floor(survivalTime);
                localStorage.setItem('highScores', JSON.stringify(highScores));
                updateHighScoreDisplay();
            }
            stopAllAudio();
            canvas.style.display = 'none';
            roundEndDiv.style.display = 'block';
        }

        // Start game loop
        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>